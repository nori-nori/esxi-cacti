#!/usr/bin/ruby
require 'rbvmomi'


# per 300 sec (300/20 = 15)
SamplingNum = 2


#
# main
#

exit 1 if ARGV.size < 1 


vim = RbVmomi::VIM.connect host: ARGV[0], user: 'root', password: 'Loto2169', insecure: true
if vim == nil 
  STDERR.puts "not connect #{ARGV[0]}"
  exit 1
end


metricsTable = {
  :default=>
["cpu.usage",
 "cpu.usagemhz",
 "cpu.reservedCapacity",
 "cpu.system",
 "cpu.wait",
 "cpu.ready",
 "cpu.used",
 "cpu.idle",
 "cpu.swapwait",
 "cpu.utilization",
 "cpu.coreUtilization",
 "cpu.totalCapacity",
 "cpu.latency",
 "cpu.entitlement",
 "cpu.demand",
 "cpu.costop",
 "cpu.maxlimited",
 "cpu.overlap",
 "cpu.run",
 "mem.usage",
 "mem.granted",
 "mem.active",
 "mem.shared",
 "mem.zero",
 "mem.unreserved",
 "mem.swapused",
 "mem.sharedcommon",
 "mem.heap",
 "mem.heapfree",
 "mem.state",
 "mem.vmmemctl",
 "mem.overhead",
 "mem.reservedCapacity",
 "mem.swapped",
 "mem.swaptarget",
 "mem.swapin",
 "mem.swapout",
 "mem.vmmemctltarget",
 "mem.consumed",
 "mem.sysUsage",
 "mem.swapinRate",
 "mem.swapoutRate",
 "mem.activewrite",
 "mem.compressed",
 "mem.compressionRate",
 "mem.decompressionRate",
 "mem.overheadMax",
 "mem.totalCapacity",
 "mem.zipped",
 "mem.zipSaved",
 "mem.latency",
 "mem.entitlement",
 "mem.lowfreethreshold",
 "mem.llSwapUsed",
 "mem.llSwapInRate",
 "mem.llSwapOutRate",
 "mem.overheadTouched",
 "mem.llSwapUsed",
 "mem.llSwapIn",
 "mem.llSwapOut",
 "disk.usage",
 "disk.numberRead",
 "disk.numberWrite",
 "disk.read",
 "disk.write",
 "disk.commands",
 "disk.commandsAborted",
 "disk.busResets",
 "disk.deviceReadLatency",
 "disk.kernelReadLatency",
 "disk.totalReadLatency",
 "disk.queueReadLatency",
 "disk.deviceWriteLatency",
 "disk.kernelWriteLatency",
 "disk.totalWriteLatency",
 "disk.queueWriteLatency",
 "disk.deviceLatency",
 "disk.kernelLatency",
 "disk.totalLatency",
 "disk.queueLatency",
 "disk.maxTotalLatency",
 "disk.maxQueueDepth",
 "disk.numberReadAveraged",
 "disk.numberWriteAveraged",
 "disk.commandsAveraged",
 "net.usage",
 "net.packetsRx",
 "net.packetsTx",
 "net.received",
 "net.transmitted",
 "net.droppedRx",
 "net.droppedTx",
 "net.bytesRx",
 "net.bytesTx",
 "net.broadcastRx",
 "net.broadcastTx",
 "net.multicastRx",
 "net.multicastTx",
 "net.errorsRx",
 "net.errorsTx",
 "net.unknownProtos",
 "sys.uptime",
 "sys.heartbeat",
 "sys.diskUsage",
 "sys.resourceCpuUsage",
 "sys.resourceMemTouched",
 "sys.resourceMemMapped",
 "sys.resourceMemShared",
 "sys.resourceMemSwapped",
 "sys.resourceMemOverhead",
 "sys.resourceMemCow",
 "sys.resourceMemZero",
 "sys.resourceCpuRun1",
 "sys.resourceCpuAct1",
 "sys.resourceCpuMaxLimited1",
 "sys.resourceCpuRun5",
 "sys.resourceCpuAct5",
 "sys.resourceCpuMaxLimited5",
 "sys.resourceCpuAllocMin",
 "sys.resourceCpuAllocMax",
 "sys.resourceCpuAllocShares",
 "sys.resourceMemAllocMin",
 "sys.resourceMemAllocMax",
 "sys.resourceMemAllocShares",
 "sys.osUptime",
 "rescpu.actav1",
 "rescpu.actpk1",
 "rescpu.runav1",
 "rescpu.actav5",
 "rescpu.actpk5",
 "rescpu.runav5",
 "rescpu.actav15",
 "rescpu.actpk15",
 "rescpu.runav15",
 "rescpu.runpk1",
 "rescpu.maxLimited1",
 "rescpu.runpk5",
 "rescpu.maxLimited5",
 "rescpu.runpk15",
 "rescpu.maxLimited15",
 "rescpu.sampleCount",
 "rescpu.samplePeriod",
 "managementAgent.memUsed",
 "managementAgent.swapUsed",
 "managementAgent.swapIn",
 "managementAgent.swapOut",
 "managementAgent.cpuUsage",
 "storageAdapter.commandsAveraged",
 "storageAdapter.numberReadAveraged",
 "storageAdapter.numberWriteAveraged",
 "storageAdapter.read",
 "storageAdapter.write",
 "storageAdapter.totalReadLatency",
 "storageAdapter.totalWriteLatency",
 "storageAdapter.maxTotalLatency",
 "storagePath.commandsAveraged",
 "storagePath.numberReadAveraged",
 "storagePath.numberWriteAveraged",
 "storagePath.read",
 "storagePath.write",
 "storagePath.totalReadLatency",
 "storagePath.totalWriteLatency",
 "storagePath.maxTotalLatency",
 "virtualDisk.numberReadAveraged",
 "virtualDisk.numberWriteAveraged",
 "virtualDisk.read",
 "virtualDisk.write",
 "virtualDisk.totalReadLatency",
 "virtualDisk.totalWriteLatency",
 "virtualDisk.readOIO",
 "virtualDisk.writeOIO",
 "virtualDisk.readLoadMetric",
 "virtualDisk.writeLoadMetric",
 "datastore.numberReadAveraged",
 "datastore.numberWriteAveraged",
 "datastore.read",
 "datastore.write",
 "datastore.totalReadLatency",
 "datastore.totalWriteLatency",
 "datastore.sizeNormalizedDatastoreLatency",
 "datastore.datastoreIops",
 "datastore.datastoreReadBytes",
 "datastore.datastoreWriteBytes",
 "datastore.datastoreReadIops",
 "datastore.datastoreWriteIops",
 "datastore.datastoreNormalReadLatency",
 "datastore.datastoreNormalWriteLatency",
 "datastore.datastoreReadOIO",
 "datastore.datastoreWriteOIO",
 "datastore.datastoreMaxQueueDepth",
 "datastore.datastoreReadLoadMetric",
 "datastore.datastoreWriteLoadMetric",
 "datastore.maxTotalLatency",
 "power.power",
 "power.powerCap",
 "power.energy",
 "hbr.hbrNumVms",
 "hbr.hbrNetRx",
 "hbr.hbrNetTx"
]}


metricsTable_Test = {
  :default=>[
 "cpu.usage",
 "cpu.usagemhz",
 "cpu.reservedCapacity",
 "cpu.system",
 "cpu.wait",
 "cpu.ready",
 "cpu.used",
 "cpu.idle",
 "cpu.swapwait",
 "cpu.utilization",
 "cpu.coreUtilization",
 "cpu.totalCapacity",
 "cpu.latency",
 "cpu.entitlement",
 "cpu.demand",
 "cpu.costop",
 "cpu.maxlimited",
 "cpu.overlap",
 "cpu.run",
 "cpu.demandEntitlementRatio",
 "mem.usage",
 "mem.granted",
 "mem.active",
 "mem.shared",
 "mem.zero",
 "mem.unreserved",
 "mem.swapused",
 "mem.sharedcommon",
 "mem.heap",
 "mem.heapfree",
 "mem.state",
 "mem.vmmemctl",
 "mem.overhead",
 "mem.reservedCapacity",
 "mem.swapped",
 "mem.swaptarget",
 "mem.swapin",
 "mem.swapout",
 "mem.vmmemctltarget",
 "mem.consumed",
 "mem.sysUsage",
 "mem.swapinRate",
 "mem.swapoutRate",
 "mem.activewrite",
 "mem.compressed",
 "mem.compressionRate",
 "mem.decompressionRate",
 "mem.overheadMax",
 "mem.totalCapacity",
 "mem.zipped",
 "mem.zipSaved",
 "mem.latency",
 "mem.entitlement",
 "mem.lowfreethreshold",
 "mem.llSwapUsed",
 "mem.llSwapInRate",
 "mem.llSwapOutRate",
 "mem.overheadTouched",
 "mem.llSwapUsed",
 "mem.llSwapIn",
 "mem.llSwapOut",
 "disk.usage",
 "disk.numberRead",
 "disk.numberWrite",
 "disk.read",
 "disk.write",
 "disk.commands",
 "disk.commandsAborted",
 "disk.busResets",
 "disk.deviceReadLatency",
 "disk.kernelReadLatency",
 "disk.totalReadLatency",
 "disk.queueReadLatency",
 "disk.deviceWriteLatency",
 "disk.kernelWriteLatency",
 "disk.totalWriteLatency",
 "disk.queueWriteLatency",
 "disk.deviceLatency",
 "disk.kernelLatency",
 "disk.totalLatency",
 "disk.queueLatency",
 "disk.maxTotalLatency",
 "disk.maxQueueDepth",
 "disk.numberReadAveraged",
 "disk.numberWriteAveraged",
 "disk.commandsAveraged",
 "net.usage",
 "net.packetsRx",
 "net.packetsTx",
 "net.received",
 "net.transmitted",
 "net.droppedRx",
 "net.droppedTx",
 "net.bytesRx",
 "net.bytesTx",
 "net.broadcastRx",
 "net.broadcastTx",
 "net.multicastRx",
 "net.multicastTx",
 "net.errorsRx",
 "net.errorsTx",
 "net.unknownProtos",
 "sys.uptime",
 "sys.heartbeat",
 "sys.diskUsage",
 "sys.resourceCpuUsage",
 "sys.resourceMemTouched",
 "sys.resourceMemMapped",
 "sys.resourceMemShared",
 "sys.resourceMemSwapped",
 "sys.resourceMemOverhead",
 "sys.resourceMemCow",
 "sys.resourceMemZero",
 "sys.resourceCpuRun1",
 "sys.resourceCpuAct1",
 "sys.resourceCpuMaxLimited1",
 "sys.resourceCpuRun5",
 "sys.resourceCpuAct5",
 "sys.resourceCpuMaxLimited5",
 "sys.resourceCpuAllocMin",
 "sys.resourceCpuAllocMax",
 "sys.resourceCpuAllocShares",
 "sys.resourceMemAllocMin",
 "sys.resourceMemAllocMax",
 "sys.resourceMemAllocShares",
 "sys.osUptime",
 "sys.resourceMemConsumed",
 "sys.resourceFdUsage",
 "rescpu.actav1",
 "rescpu.actpk1",
 "rescpu.runav1",
 "rescpu.actav5",
 "rescpu.actpk5",
 "rescpu.runav5",
 "rescpu.actav15",
 "rescpu.actpk15",
 "rescpu.runav15",
 "rescpu.runpk1",
 "rescpu.maxLimited1",
 "rescpu.runpk5",
 "rescpu.maxLimited5",
 "rescpu.runpk15",
 "rescpu.maxLimited15",
 "rescpu.sampleCount",
 "rescpu.samplePeriod",
 "managementAgent.memUsed",
 "managementAgent.swapUsed",
 "managementAgent.swapIn",
 "managementAgent.swapOut",
 "managementAgent.cpuUsage",
 "storageAdapter.commandsAveraged",
 "storageAdapter.numberReadAveraged",
 "storageAdapter.numberWriteAveraged",
 "storageAdapter.read",
 "storageAdapter.write",
 "storageAdapter.totalReadLatency",
 "storageAdapter.totalWriteLatency",
 "storageAdapter.maxTotalLatency",
 "storagePath.commandsAveraged",
 "storagePath.numberReadAveraged",
 "storagePath.numberWriteAveraged",
 "storagePath.read",
 "storagePath.write",
 "storagePath.totalReadLatency",
 "storagePath.totalWriteLatency",
 "storagePath.maxTotalLatency",
 "virtualDisk.numberReadAveraged",
 "virtualDisk.numberWriteAveraged",
 "virtualDisk.read",
 "virtualDisk.write",
 "virtualDisk.totalReadLatency",
 "virtualDisk.totalWriteLatency",
 "virtualDisk.readOIO",
 "virtualDisk.writeOIO",
 "virtualDisk.readLoadMetric",
 "virtualDisk.writeLoadMetric",
 "virtualDisk.readIOSize",
 "virtualDisk.writeIOSize",
 "virtualDisk.smallSeeks",
 "virtualDisk.mediumSeeks",
 "virtualDisk.largeSeeks",
 "virtualDisk.readLatencyUS",
 "virtualDisk.writeLatencyUS",
 "virtualDisk.vFlashCacheIops",
 "virtualDisk.vFlashCacheLatency",
 "virtualDisk.vFlashCacheThroughput",
 "datastore.numberReadAveraged",
 "datastore.numberWriteAveraged",
 "datastore.read",
 "datastore.write",
 "datastore.totalReadLatency",
 "datastore.totalWriteLatency",
 "datastore.sizeNormalizedDatastoreLatency",
 "datastore.datastoreIops",
 "datastore.datastoreReadBytes",
 "datastore.datastoreWriteBytes",
 "datastore.datastoreReadIops",
 "datastore.datastoreWriteIops",
 "datastore.datastoreNormalReadLatency",
 "datastore.datastoreNormalWriteLatency",
 "datastore.datastoreReadOIO",
 "datastore.datastoreWriteOIO",
 "datastore.datastoreMaxQueueDepth",
 "datastore.datastoreReadLoadMetric",
 "datastore.datastoreWriteLoadMetric",
 "datastore.maxTotalLatency",
 "datastore.siocActiveTimePercentage",
 "datastore.datastoreVMObservedLatency",
 "power.power",
 "power.powerCap",
 "power.energy",
 "hbr.hbrNumVms",
 "hbr.hbrNetRx",
 "hbr.hbrNetTx",
 "vflashModule.numActiveVMDKs",
 "vsanDomObj.readIops",
 "vsanDomObj.readThroughput",
 "vsanDomObj.readAvgLatency",
 "vsanDomObj.readMaxLatency",
 "vsanDomObj.readCacheHitRate",
 "vsanDomObj.readCongestion",
 "vsanDomObj.writeIops",
 "vsanDomObj.writeThroughput",
 "vsanDomObj.writeAvgLatency",
 "vsanDomObj.writeMaxLatency",
 "vsanDomObj.writeCongestion",
 "vsanDomObj.recoveryWriteIops",
 "vsanDomObj.recoveryWriteThroughput",
 "vsanDomObj.recoveryWriteAvgLatency",
 "vsanDomObj.recoveryWriteMaxLatency",
 "vsanDomObj.recoveryWriteCongestion"
  ]
}

optionTable = {
  :throughput=>{
    :instance=>""
  }
}

metrics = metricsTable[ARGV[1].to_s.to_sym] || metricsTable[:default]
option = optionTable[ARGV[1].to_s.to_sym] || {}
option[:max_samples] = SamplingNum
option[:multi_instance] = true

host = vim.root.childEntity[0].hostFolder.childEntity[0].host
counter = vim.serviceContent.perfManager.retrieve_stats(host, metrics, option)


if counter == nil then
  STDERR.puts "error"
  exit 0
end


  # for debug
  pp counter[host[0]][:metrics].sort


exit 0
